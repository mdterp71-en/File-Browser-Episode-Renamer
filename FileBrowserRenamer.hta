<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=9" />
<title>File Browser Episode Renamer</title>
<HTA:APPLICATION
  APPLICATIONNAME="FileBrowserRenamer"
  ID="FileBrowserRenamer"
  VERSION="1.0"
  BORDER="thin"
  BORDERSTYLE="normal"
  WINDOWSTATE="normal"
  SCROLL="no"
  SINGLEINSTANCE="yes"
  CAPTION="yes"
/>
<style>
* { box-sizing:border-box; margin:0; padding:0; }
body { background:#1e1e2e; color:#cdd6f4; font-family:Segoe UI,Tahoma,Arial,sans-serif; font-size:13px; overflow:hidden; }

#topbar  { position:absolute; left:0; top:0; right:0; height:4px; background:#7c6af7; }
#header  { position:absolute; left:0; top:4px; right:0; height:44px; background:#1e1e2e; border-bottom:1px solid #313244; padding:8px 14px; }
#header h1 { font-size:14px; color:#cdd6f4; margin:0 0 2px 0; }
#header p  { font-size:11px; color:#888aaa; margin:0; }

#left  { position:absolute; left:0; top:48px; width:262px; bottom:44px; background:#2a2a3e; border-right:1px solid #313244; overflow-y:auto; padding:10px; }
#right { position:absolute; left:262px; top:48px; right:0; bottom:44px; background:#1e1e2e; overflow:hidden; }
#bottom{ position:absolute; left:0; bottom:0; right:0; height:44px; background:#1a1a2e; border-top:1px solid #313244; padding:7px 12px; }

/* LEFT FORM STYLES */
.sec  { font-size:10px; color:#666880; text-transform:uppercase; letter-spacing:1px; margin:10px 0 3px 0; font-weight:bold; }
.lbl  { display:block; font-size:11px; color:#888aaa; font-weight:bold; margin:7px 0 2px 0; }
.inp  { width:100%; background:#313244; border:1px solid #45475a; color:#cdd6f4; padding:5px 7px; font-size:12px; font-family:Segoe UI,Tahoma,Arial,sans-serif; }
.inpN { width:78px; background:#313244; border:1px solid #45475a; color:#cdd6f4; padding:5px 7px; font-size:12px; font-family:Segoe UI,Tahoma,Arial,sans-serif; }
.hint { font-size:10px; color:#555770; margin-top:2px; }
.btn  { display:block; width:100%; padding:7px; border:none; font-size:12px; font-weight:bold; cursor:pointer; margin-top:8px; font-family:Segoe UI,Tahoma,Arial,sans-serif; }
.btnB { background:#5a9cf8; color:#fff; }
.btnP { background:#7c6af7; color:#fff; }
hr    { border:none; border-top:1px solid #45475a; margin:10px 0 2px 0; }
#loginBox { margin-top:5px; padding:4px 6px; font-size:11px; background:#252536; min-height:18px; word-wrap:break-word; }
.ok  { color:#a6e3a1; }
.err { color:#f38ba8; }
.dim { color:#888aaa; }
.chkrow { margin-top:6px; }
.chkrow input { margin-right:4px; }

/* RIGHT - breadcrumb + folders + file table */
#breadcrumb { position:absolute; left:0; top:0; right:0; height:30px; background:#252538; border-bottom:1px solid #313244; padding:5px 10px; overflow:hidden; white-space:nowrap; }
.crumb     { font-size:12px; color:#5a9cf8; cursor:pointer; }
.crumb-sep { font-size:12px; color:#45475a; margin:0 2px; }
.crumb-cur { font-size:12px; color:#cdd6f4; font-weight:bold; }

#folder-bar   { position:absolute; left:0; top:30px; right:0; height:24px; background:#1a1a2e; padding:4px 10px 0 10px; font-size:10px; color:#555770; text-transform:uppercase; letter-spacing:1px; border-bottom:none; }
#folders-area { position:absolute; left:0; top:54px; right:0; height:120px; background:#1a1a2e; border-bottom:1px solid #313244; padding:5px 7px; overflow-y:auto; }
.fitem    { display:inline-block; background:#2a2a3e; color:#cdd6f4; padding:3px 10px; font-size:12px; cursor:pointer; border:1px solid #45475a; margin:2px 2px; white-space:nowrap; }
.fitem-up { background:#2e2e4a; color:#a6adff; border-color:#7c6af7; }
.fmsg     { font-size:11px; color:#555770; padding:5px 3px; }

#filesbar  { position:absolute; left:0; top:174px; right:0; height:30px; background:#2a2a3e; border-bottom:1px solid #313244; padding:4px 8px; }
#filecount { font-size:11px; color:#888aaa; display:inline; margin-right:8px; }
.sm  { padding:3px 11px; border:none; font-size:11px; font-weight:bold; cursor:pointer; font-family:Segoe UI,Tahoma,Arial,sans-serif; }
.smB { background:#5a9cf8; color:#fff; }
.smP { background:#7c6af7; color:#fff; }

#tableWrap { position:absolute; left:0; top:204px; right:0; bottom:0; overflow-y:auto; overflow-x:auto; }
table  { width:100%; border-collapse:collapse; font-size:12px; font-family:Consolas,Courier New,monospace; }
th     { background:#1a1a2e; color:#888aaa; padding:5px 8px; text-align:left; font-size:11px; }
td     { padding:4px 8px; border-bottom:1px solid #252536; }
.cn    { color:#555770; width:32px; }
.co    { color:#cdd6f4; }
.cv    { color:#5a9cf8; }
.cs    { width:74px; text-align:center; font-size:11px; }

/* BOTTOM */
#statusMsg { display:inline; font-size:11px; color:#888aaa; }
.actB { padding:5px 14px; border:none; font-size:12px; font-weight:bold; cursor:pointer; float:right; margin-left:6px; font-family:Segoe UI,Tahoma,Arial,sans-serif; }
.green { background:#a6e3a1; color:#1e1e2e; }
.gray  { background:#45475a; color:#cdd6f4; }
</style>
</head>
<body>

<div id="topbar"></div>

<div id="header">
  <h1>File Browser -- Remote Episode Renamer</h1>
  <p>Browse folders on your seedbox and rename files with S01E01 style codes</p>
</div>

<!-- LEFT PANEL -->
<div id="left">

  <div class="sec">CONNECTION</div>

  <div style="background:#2e2e1a; border:1px solid #6a5a10; color:#f9e2af; font-size:11px; padding:6px 8px; margin-bottom:6px; line-height:1.7;">
    Enter your File Browser URL below.<br>
    Example: https://yourname.server.com/filebrowser
  </div>

  <span class="lbl">File Browser URL</span>
  <input class="inp" type="text" id="url" value="" />
  <div class="hint">No trailing slash. No /files at the end.</div>

  <span class="lbl">Username</span>
  <input class="inp" type="text" id="uname" value="" />

  <span class="lbl">Password</span>
  <input class="inp" type="password" id="pass" value="" />

  <button class="btn btnB" onclick="doLogin()">Login</button>
  <div id="loginBox" class="dim">Not logged in</div>

  <hr>
  <div class="sec">FILE FILTER</div>
  <div class="chkrow">
    <input type="checkbox" id="chkExt" checked />
    <span style="font-size:11px; color:#888aaa; font-weight:bold;">Filter by extension</span>
  </div>
  <input class="inp" type="text" id="extFilter" value=".mkv .mp4 .avi" style="margin-top:4px" />
  <div class="hint">Space or comma separated. Uncheck to show all files.</div>

  <hr>
  <div class="sec">EPISODE SETTINGS</div>

  <span class="lbl">Starting Season</span>
  <input class="inpN" type="text" id="startSeason" value="1" />

  <span class="lbl">Starting Episode</span>
  <input class="inpN" type="text" id="startEp" value="1" />

  <span class="lbl">Episodes per Season</span>
  <input class="inpN" type="text" id="perSeason" value="20" />
  <div class="hint">Rolls to next season automatically</div>

  <hr>
  <div class="hint" style="font-size:11px; color:#888aaa; margin-top:4px; line-height:1.7">
    Output format:<br>
    <span style="color:#5a9cf8; font-family:Consolas,monospace; font-size:12px">S01E01 - Original Name.mkv</span>
  </div>

</div>

<!-- RIGHT PANEL -->
<div id="right">

  <div id="breadcrumb">
    <span id="bcLabel" style="font-size:10px; color:#555770; margin-right:4px;">Location:</span>
    <span id="crumbs" style="font-size:12px; color:#555770;">Log in to start browsing</span>
  </div>

  <div id="folder-bar">Subfolders -- click to open</div>

  <div id="folders-area">
    <span class="fmsg">Log in first, then folders will appear here.</span>
  </div>

  <div id="filesbar">
    <span id="filecount">No files loaded</span>
    <span style="float:right">
      <button class="sm smB" onclick="loadCurrentFolder()">Reload</button>
      &nbsp;
      <button class="sm smP" onclick="doPreview()">Preview Rename</button>
    </span>
  </div>

  <div id="tableWrap">
    <table id="fileTable">
      <thead>
        <tr>
          <th class="cn">#</th>
          <th>Current Filename</th>
          <th>New Filename (Preview)</th>
          <th class="cs">Status</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

</div>

<!-- BOTTOM BAR -->
<div id="bottom">
  <button class="actB green" onclick="doRename()">Rename on Server</button>
  <button class="actB gray"  onclick="doClear()">Clear</button>
  <span id="statusMsg">Log in and browse to a folder to get started.</span>
</div>

<script language="JScript">

var gToken   = "";
var gBaseUrl = "";
var gCurPath = "/media";
var gFiles   = [];
var gPreview = [];

function trim(s){ return (s||"").replace(/^\s+|\s+$/g,""); }

function setStatus(msg,color){
  var el=document.getElementById("statusMsg");
  el.innerText=msg; el.style.color=color||"#888aaa";
}

function setLoginMsg(msg,cls){
  var el=document.getElementById("loginBox");
  el.innerText=msg; el.className=cls||"dim";
}

// ── HTTP via WinHttp (handles HTTPS + SSL errors) ──────────────────
function httpCall(method, url, body, token){
  var http;
  try{
    http = new ActiveXObject("WinHttp.WinHttpRequest.5.1");
  } catch(e){
    return {ok:false, status:0, text:"WinHttp not available: "+e.message};
  }

  try{
    http.Open(method, url, false);
    // Ignore SSL certificate errors: flag 0x3300 = 13056
    http.Option(4) = 13056;
    if(token) http.SetRequestHeader("X-Auth", token);
    if(body)  http.SetRequestHeader("Content-Type","application/json");
    http.Send(body||"");
  } catch(e){
    return {ok:false, status:0, text:"Request error: "+e.message};
  }

  var st = 0;
  try{ st = http.Status; } catch(e){}
  var tx = "";
  try{ tx = http.ResponseText; } catch(e){}

  return { ok:(st>=200 && st<300), status:st, text:tx };
}

// ── Path encoding ──────────────────────────────────────────────────
function encodePath(path){
  var parts=path.split("/"), out=[];
  for(var i=0;i<parts.length;i++) out.push(encodeURIComponent(parts[i]));
  return out.join("/");
}

// ── Clear a tbody safely (no innerHTML on tables in old IE) ────────
function clearTbody(){
  var tb=document.getElementById("tbody");
  while(tb.firstChild) tb.removeChild(tb.firstChild);
}

// ── LOGIN ──────────────────────────────────────────────────────────
function doLogin(){
  var url   = trim(document.getElementById("url").value).replace(/\/+$/,"");
  var uname = trim(document.getElementById("uname").value);
  var pass  = document.getElementById("pass").value;

  if(!url||!uname||!pass){ alert("Please fill in the URL, username, and password."); return; }

  gBaseUrl=url;
  setLoginMsg("Connecting...","dim");

  var safeU=uname.replace(/\\/g,"\\\\").replace(/"/g,'\\"');
  var safeP=pass.replace(/\\/g,"\\\\").replace(/"/g,'\\"');
  var body='{"username":"'+safeU+'","password":"'+safeP+'"}';

  var r=httpCall("POST", url+"/api/login", body, null);

  if(r.ok && r.text){
    gToken=r.text.replace(/^\s*"?|"?\s*$/g,"");
    setLoginMsg("Logged in as: "+uname,"ok");
    setStatus("Logged in! Loading /media ...","#5a9cf8");
    navigateTo("/media");
  } else {
    gToken="";
    var msg;
    if     (r.status===0)   msg="Cannot reach server. Check the URL is correct.";
    else if(r.status===401) msg="Unauthorized (401). Check username and password.";
    else if(r.status===403) msg="Wrong username or password (403).";
    else if(r.status===404) msg="Not found (404). Check the URL has no typos.";
    else                    msg="HTTP "+r.status+" -- "+r.text.substring(0,120);
    setLoginMsg(msg,"err");
    setStatus("Login failed.","#f38ba8");
  }
}

// ── NAVIGATE ──────────────────────────────────────────────────────
function navigateTo(path){
  if(!gToken){ alert("Please log in first."); return; }
  if(path.charAt(0)!=="/") path="/"+path;
  path=path.replace(/\/+$/,"")||"/";

  setStatus("Loading "+path+" ...","#888aaa");

  var r=httpCall("GET", gBaseUrl+"/api/resources"+encodePath(path), null, gToken);

  if(!r.ok){
    var msg="Cannot open folder -- HTTP "+r.status;
    if(r.status===0) msg="Connection lost. Try logging in again.";
    setStatus(msg,"#f38ba8");
    alert(msg+"\n\n"+r.text.substring(0,200));
    return;
  }

  var data;
  try{ data=eval("("+r.text+")"); }
  catch(e){ alert("Error reading response:\n"+e.message); return; }

  gCurPath=path;
  gFiles=[]; gPreview=[];

  var items=data.items||[];
  var folders=[],files=[];
  for(var i=0;i<items.length;i++){
    if(items[i].isDir) folders.push(items[i].name);
    else               files.push(items[i].name);
  }
  folders.sort(); files.sort();

  renderBreadcrumb(path);
  renderFolders(folders,path);
  renderFiles(files);
}

function loadCurrentFolder(){ navigateTo(gCurPath); }

// ── BREADCRUMB ─────────────────────────────────────────────────────
function renderBreadcrumb(path){
  var c=document.getElementById("crumbs");
  // Clear safely
  while(c.firstChild) c.removeChild(c.firstChild);

  var parts=path.replace(/^\/+/,"").split("/");

  var root=document.createElement("span");
  root.className="crumb"; root.innerText="[media]";
  root.onclick=function(){ navigateTo("/media"); };
  c.appendChild(root);

  for(var i=1;i<parts.length;i++){
    var cumPath="/"+parts.slice(0,i+1).join("/");
    var sep=document.createElement("span"); sep.className="crumb-sep"; sep.innerText=" > ";
    c.appendChild(sep);
    if(i===parts.length-1){
      var cur=document.createElement("span"); cur.className="crumb-cur"; cur.innerText=parts[i];
      c.appendChild(cur);
    } else {
      var lnk=document.createElement("span"); lnk.className="crumb"; lnk.innerText=parts[i];
      lnk.onclick=(function(p){ return function(){ navigateTo(p); }; })(cumPath);
      c.appendChild(lnk);
    }
  }
}

// ── FOLDERS ────────────────────────────────────────────────────────
function renderFolders(folders,curPath){
  var area=document.getElementById("folders-area");
  while(area.firstChild) area.removeChild(area.firstChild);

  if(curPath!=="/media" && curPath!=="/"){
    var upParts=curPath.split("/"); upParts.pop();
    var upPath=upParts.join("/")||"/media";
    if(upPath.indexOf("/media")<0) upPath="/media";
    var up=document.createElement("div");
    up.className="fitem fitem-up"; up.innerText="[ Up one level ]";
    up.onclick=(function(p){ return function(){ navigateTo(p); }; })(upPath);
    area.appendChild(up);
  }

  if(folders.length===0){
    var m=document.createElement("span"); m.className="fmsg"; m.innerText="No subfolders here.";
    area.appendChild(m); return;
  }

  for(var i=0;i<folders.length;i++){
    var d=document.createElement("div"); d.className="fitem"; d.innerText=folders[i];
    d.onclick=(function(fp){ return function(){ navigateTo(fp); }; })(curPath+"/"+folders[i]);
    area.appendChild(d);
  }
}

// ── FILES ──────────────────────────────────────────────────────────
function renderFiles(files){
  if(document.getElementById("chkExt").checked){
    var raw=document.getElementById("extFilter").value.toLowerCase();
    var exts=trim(raw).split(/[\s,]+/);
    for(var i=0;i<exts.length;i++) if(exts[i]&&exts[i].charAt(0)!==".") exts[i]="."+exts[i];
    var out=[];
    for(var i=0;i<files.length;i++){
      var dot=files[i].lastIndexOf(".");
      var ext=dot>=0?files[i].substring(dot).toLowerCase():"";
      for(var j=0;j<exts.length;j++) if(ext===exts[j]){ out.push(files[i]); break; }
    }
    files=out;
  }

  gFiles=[]; gPreview=[];
  for(var i=0;i<files.length;i++) gFiles.push(files[i]);

  clearTbody();
  var tb=document.getElementById("tbody");

  for(var i=0;i<gFiles.length;i++){
    var tr=document.createElement("tr"); tr.id="row"+i;

    var a=document.createElement("td"); a.className="cn";
    a.appendChild(document.createTextNode(i+1)); tr.appendChild(a);

    var b=document.createElement("td"); b.className="co";
    b.appendChild(document.createTextNode(gFiles[i])); tr.appendChild(b);

    var cv=document.createElement("td"); cv.className="cv"; cv.id="new"+i;
    cv.style.color="#45475a";
    cv.appendChild(document.createTextNode("-- click Preview Rename --")); tr.appendChild(cv);

    var d=document.createElement("td"); d.className="cs"; d.id="stat"+i; tr.appendChild(d);

    tb.appendChild(tr);
  }

  document.getElementById("filecount").innerText=gFiles.length+" file(s) in "+gCurPath;
  setStatus("Showing "+gFiles.length+" file(s) -- set episode numbers then click Preview Rename.","#5a9cf8");
}

// ── PREVIEW ────────────────────────────────────────────────────────
function pad(n){ return n<10?"0"+n:""+n; }

function getCodes(count){
  var s=parseInt(document.getElementById("startSeason").value,10)||1;
  var e=parseInt(document.getElementById("startEp").value,    10)||1;
  var p=parseInt(document.getElementById("perSeason").value,  10)||20;
  if(p<1) p=99;
  var codes=[];
  for(var i=0;i<count;i++){
    codes.push("S"+pad(s)+"E"+pad(e));
    e++; if(e>p){e=1;s++;}
  }
  return codes;
}

function doPreview(){
  if(gFiles.length===0){ alert("Navigate to a folder with files first."); return; }
  var codes=getCodes(gFiles.length);
  gPreview=[];
  for(var i=0;i<gFiles.length;i++){
    var orig=gFiles[i];
    var dot=orig.lastIndexOf(".");
    var base=dot>=0?orig.substring(0,dot):orig;
    var ext =dot>=0?orig.substring(dot):"";
    // Strip any existing S##E## pattern (and surrounding spaces/dots/dashes)
    base=base.replace(/[\s.\-_]*S\d{1,2}E\d{1,3}[\s.\-_]*/gi,"");
    // Remove any leading/trailing spaces, dots, dashes left over
    base=base.replace(/^[\s.\-_]+|[\s.\-_]+$/g,"");
    // Remove spaces and dashes -- only commas allowed in the title
    base=base.replace(/\s+/g,"").replace(/-+/g,"");
    // Format: S01E01.OriginalName.ext  (period after code, no spaces)
    var nw=codes[i]+"."+base+ext;
    gPreview.push({old:orig,nw:nw});
    var td=document.getElementById("new"+i);
    while(td.firstChild) td.removeChild(td.firstChild);
    td.appendChild(document.createTextNode(nw)); td.style.color="#5a9cf8";
    var st=document.getElementById("stat"+i);
    while(st.firstChild) st.removeChild(st.firstChild);
    st.appendChild(document.createTextNode("Preview")); st.style.color="#5a9cf8";
  }
  setStatus("Preview ready -- review carefully, then click Rename on Server.","#7c6af7");
}

// ── RENAME ─────────────────────────────────────────────────────────
function doRename(){
  if(gPreview.length===0){ alert("Click Preview Rename first."); return; }
  if(!gToken){ alert("Not logged in. Please log in again."); return; }

  var seen={};
  for(var i=0;i<gPreview.length;i++){
    if(seen[gPreview[i].nw]){ alert("Duplicate new names detected. Adjust settings."); return; }
    seen[gPreview[i].nw]=1;
  }

  var prev="";
  var max=gPreview.length<5?gPreview.length:5;
  for(var i=0;i<max;i++) prev+="\n  "+gPreview[i].old+"  ->  "+gPreview[i].nw;
  if(gPreview.length>5) prev+="\n  ... and "+(gPreview.length-5)+" more";
  if(!confirm("Rename "+gPreview.length+" file(s) in "+gCurPath+"?"+prev+"\n\nThis modifies files on your seedbox.")) return;

  var rpath=gCurPath.replace(/\/+$/,"");
  var ok=0,errs=[];

  for(var i=0;i<gPreview.length;i++){
    var oldName=gPreview[i].old, newName=gPreview[i].nw;
    var oldParts=(rpath+"/"+oldName).split("/"), oldEnc=[];
    for(var j=0;j<oldParts.length;j++) oldEnc.push(encodeURIComponent(oldParts[j]));
    var oldPath=oldEnc.join("/");
    var destEnc=encodeURIComponent(rpath+"/"+newName);
    var r=httpCall("PATCH", gBaseUrl+"/api/resources/"+oldPath+"?action=rename&destination="+destEnc, null, gToken);
    var st=document.getElementById("stat"+i);
    while(st.firstChild) st.removeChild(st.firstChild);
    if(r.ok||r.status===200||r.status===204){
      ok++;
      st.appendChild(document.createTextNode("Done")); st.style.color="#a6e3a1";
      document.getElementById("row"+i).style.color="#a6e3a1";
    } else {
      errs.push(oldName+" (HTTP "+r.status+")");
      st.appendChild(document.createTextNode("Error")); st.style.color="#f38ba8";
      document.getElementById("row"+i).style.color="#f38ba8";
    }
  }

  gPreview=[]; gFiles=[];
  if(errs.length===0){
    setStatus(ok+" file(s) renamed successfully!","#a6e3a1");
    alert(ok+" file(s) renamed successfully!");
  } else {
    var msg=ok+" renamed.  "+errs.length+" failed:\n"+errs.join("\n");
    setStatus(msg,"#f38ba8"); alert(msg);
  }
}

function doClear(){
  clearTbody(); gFiles=[]; gPreview=[];
  document.getElementById("filecount").innerText="No files loaded";
  setStatus("Cleared.","#888aaa");
}

document.getElementById("pass").onkeydown=function(e){
  if((e||window.event).keyCode===13) doLogin();
};

window.resizeTo(1100,760);
</script>
</body>
</html>
